一、相关环境

\-    JDK 1.8.0_92 (Java SDK [oxidyc/smart-resources/JavaSDK.md](https://github.com/oxidyc/smart-resources/blob/master/JavaSDK.md))

\-    IntelliJ IDEA 2018.3  (IntelliJ IDEA Tutorial [oxidyc/smart-resources/JetBrains-IntelliJ-IDEA.md](https://github.com/oxidyc/smart-resources/blob/master/JetBrains-IntelliJ-IDEA.md))

\-    Tomcat 8.0.35  (Git Tutorial [oxidyc/smart-resources/Git.md](https://github.com/oxidyc/smart-resources/blob/master/Git.md))

\-    Spring 4.2.6 (springboot [oxidyc/smart-resources/springboot](https://github.com/oxidyc/smart-resources/tree/master/springboot))

\-    MySql 5.7 + Navicat 12 (Navicat Tutorial [oxidyc/smart-resources/Apache-Maven.md](https://github.com/oxidyc/smart-resources/blob/master/Navicat.md))

\-    Maven 3.3.9  (Apache Maven Tutorial  [oxidyc/smart-resources/Apache-Maven.md](https://github.com/oxidyc/smart-resources/blob/master/Apache-Maven.md))

\-    Bootstrap 3.3.5



### 二、本地Maven与Tomcat的安装

#### 1、下载并安装本地maven    

​    点击“[**Apache-Maven官方网站**](http://maven.apache.org/)”进入官网，点击左侧Download选项：

![1561281657017](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561281657017.png)

​     进入了下载页面，往下拉可发现当前版本是3.3.3，点击下面红框中的[apache-maven-3.3.9-bin.zip](http://apache.opencas.org/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.zip)就可下载，下载后解压缩到相应目录下：

![1561281669342](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561281669342.png)

​    新增系统变量MAVEN_HOME：即MAVEN安装目录：

![1561281676722](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561281676722.png)

​    在Path中加入：%MAVEN_HOME%\bin;    

![1561281776987](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561281776987.png)

   在cmd中输入mvn -v，若显示如下，则说明本地maven配置完成：

![1561281512174](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561281512174.png)

#### 2、下载并安装本地Tomcat

进入[Tomcat官网](http://tomcat.apache.org/)，点击左侧Download的Tomcat8.0，进入Tomcat的下载页面：



64位Windows版本下载[64-bit Windows zip (pgp, md5, sha1)](https://tomcat.apache.org/download-80.cgi)，解压到所需目录下：

![1561281844648](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561281844648.png)

解压后到\bin\目录下运行startup.bat，如图下所示，如果出现Server startup in xxxx ms说明Tomcat安装成功。

![1561282032937](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561282032937.png)



### 三、创建Maven Web项目

​    前面说了这么多，差不多基本的东西都保障了（前提保证已经安装了jdk）。创建一个Web项目，对于不使用Maven的开发者，可以直接建一个简单的Web项目。使用Maven的话，按照图进行操作。

![1561282186233](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561282186233.png)

​    菜单File->New Project可进入上图界面，首先选择左边栏Maven，再配置JDK（一般如果之前添加了JDK的话会自动填充，如未添加的话点击旁边的New将JDK目录导入即可）。勾选“Create from archetype“，然后选中4处蓝色位置webapp，点Next，进入如下界面：

![1561282232544](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561282232544.png)

​    这里需要填写GroupId和ArtifactId还有Version，这三个属性目的是标识你的项目的唯一性，比如Tomcat的GroupId是org.apache，即它是apache组织的项目，ArtifactId是tomcat，项目名为tomcat，而我当前使用的Version是7.0.68。这些只在发布时有用，在此可以随便填写，填好后点Next，到如下界面。

​    打开Maven home directory，可以发现IntelliJ IDEA已经集成了Maven 2和Maven 3两个版本，如果使用默认集成的maven的话，选择Buldled(Maven 3)，直接点击Next。

![1561282241788](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561282241788.png)

   我们也可以导入本地新安装的较新的Maven版本，点击蓝色箭头右边的 ... 按钮将Maven路径导入即可，点击Next：

![1561282251233](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561282251233.png)

   填写项目名，选择项目保存路径，点击Finish：

![1561282261253](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561282261253.png)

   进入如下界面，maven会在后台生成web项目，这需要等待一定的时间，视网络环境而定，经验发现用较新版本的maven项目生成更快，使用IDEA集成的maven可能会等待很长一段实践。

![1561282293452](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561282293452.png)

​    左边红框中展示了该项目的文件结构。可以发现，它在src/main下创建了一个recources文件夹，该文件夹一般用来存放一些资源文件，还有一个webapp文件夹，用来存放web配置文件以及jsp页面等，这已经组成了一个原始的web应用。选择右边红框的Enable-Auto-Import，可以在每次修改pom.xml后，自动的下载并导入jar包，这一点在后面详述。



### 四、Maven自动导入jar包

​    既然我们要用SpringMVC开发，那肯定少不了SpringMVC的相关jar包。如果不使用Maven的话，那就需要去官网下载相关的jar包，然后导入到项目中。现在使用maven的话，就不需要上网找jar包了。具体容我一一道来。

​    Maven所做的工作其实很简单，就是自动把需要的jar包下载到本地，然后关联到项目中来。maven的所有jar包都是保存在几个中央仓库里面的，其中一个最常用的是[**Maven Repository**](http://mvnrepository.com/)，即，需要什么jar包，它就会从仓库中拿给你。那么如何告诉maven需要什么jar包呢？我们看看工程目录，能找到一个pom.xml文件，maven就是靠它来定义需求的，代码如下：

```
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.gdtop</groupId>
    <artifactId>springmvcdemo</artifactId>
    <packaging>war</packaging>
    <version>1.0-SNAPSHOT</version>
    <name>springmvcdemo Maven Webapp</name>
    <url>http://maven.apache.org</url>
    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>3.8.1</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
    <build>
        <finalName>springmvcdemo</finalName>
    </build>
</project>
```

​    我们可以看到这个文件包含了我们之前定义的本项目的gropId等信息，这些信息是该项目的标识，我们不要去改动它们。重点看<dependencies>标签，翻译过来是”依赖“的意思，也就是说把对每个包的需求都称为一个依赖<depedency>，定义在<dependencies>中。在每个<depedency>中，你需要提供的是所需jar包的groupId、artifactId、version这三个必要信息。比如上面我们看到引入可一个junit包，格式如下：

```
<dependency>
    <groupId>junit</groupId>
    <artifactId>junit</artifactId>
    <version>3.8.1</version>
    <scope>test</scope>
</dependency>
```

​    这是单元测试包，提供了三个基本信息，第4个scope对其他包来说是非必需的。所有jar包的引入都要满足这个格式。那么如何查看这些jar包的3个信息呢，可能刚接触是开发者还不是很熟悉，这个时候就需要查阅仓库了。比如我们需要引入Spring核心jar包spring-core，打开**Maven Repository，**搜索spring-core，进入如下界面：

![img](http://static.oschina.net/uploads/space/2016/0308/111417_iBG3_2287879.png)

点击进入红框选中的Spring Core，如下所示，可以看到各版本的使用情况：

![img](http://static.oschina.net/uploads/space/2016/0308/111847_GeLG_2287879.png)

 选择最新版本4.2.5.RELEASE，可以看到其dependency写法如下红框所示：

![img](http://static.oschina.net/uploads/space/2016/0308/112014_KnIF_2287879.png)

 我们将其复制到pom.xml中的<dependencies>中：

![img](http://static.oschina.net/uploads/space/2016/0308/112339_FuQC_2287879.png)

这样，Maven就会开始自动下载jar包到本地仓库，然后关联到你的项目中，下载完成后，我们展开工程目录中External Libraries：

![img](http://static.oschina.net/uploads/space/2016/0308/112911_sL2Z_2287879.png)

​    可以发现，虽然我们只写了一个依赖，但是它导入了两个jar包，也就是说，导入某个jar包时，与它密切相关的jar包也会同时被导入进来。

​    除了spring-core，我还要spring-context，复制spring-core的<dependency>，将spring-core改为spring-context，如下：

```
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-context</artifactId>
    <version>4.2.5.RELEASE</version>
</dependency>
```

​    下载完成后，查看External Libraries，会不会发现，瞬间导入了好多jar包（当然不是瞬间，这得看你的网速了）呢：

![img](http://static.oschina.net/uploads/space/2016/0308/113223_hWAz_2287879.png)

​    这就是Maven的强大之处，如果你需要使用SpringMVC开发网站的话，只需记住几个重要的包的名字，就可以轻松将所有包导入项目中。

​    长话短说，现在我们要进行SpringMVC的开发，请把你的pom.xml变成下面的样子，当然不要改你的grupId等信息（从modelVersion到url都不要动）：

```
<properties>
    <spring.version>4.2.6.RELEASE</spring.version>
    <hibernate.version>5.1.0.Final</hibernate.version>
</properties>
```

​    请在<dependencies>中加入以下依赖：

```
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-webmvc</artifactId>
            <version>${spring.version}</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.data</groupId>
            <artifactId>spring-data-jpa</artifactId>
            <version>1.10.1.RELEASE</version>
        </dependency>

        <dependency>
            <groupId>org.hibernate</groupId>
            <artifactId>hibernate-entitymanager</artifactId>
            <version>${hibernate.version}</version>
        </dependency>

        <dependency>
            <groupId>org.hibernate</groupId>
            <artifactId>hibernate-c3p0</artifactId>
            <version>${hibernate.version}</version>
        </dependency>

        <dependency>
            <groupId>com.mchange</groupId>
            <artifactId>c3p0</artifactId>
            <version>0.9.5.2</version>
        </dependency>

        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>jstl</artifactId>
            <version>1.2</version>
        </dependency>

        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.39</version>
        </dependency>
```

将<build>改成如下形式：

```
    <build>
        <finalName>springmvcdemo</finalName>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
```

​    

我们可以发现，除了导入了spring相关jar包，还有一些其他的包，这些包都是有作用的，我们后面慢慢说。如果不使用Maven请自行下载spring、hibernate、mysql、jstl等相关jar包然后导入到工程中。至此，jar包的导入就完成了，我们按 ctrl+alt+shift+s，或者File->Project Structure查看一下项目结构，看看有什么问题：

![img](http://static.oschina.net/uploads/space/2016/0713/234151_HxRP_2287879.png)

​    由于之后我们要开始写代码了，先做一些配置，选择Modules，在SpringMVCDemo的src\main文件夹中新建一个文件夹，取名为java：

![img](http://static.oschina.net/uploads/space/2016/0308/114117_ldQB_2287879.png)

   选中java文件夹，点击上面的Make as：Sources，该文件夹就会变成蓝色，用以保存java代码，按OK，结束配置。

![img](http://static.oschina.net/uploads/space/2016/0308/114345_6NFb_2287879.png)





### 五、SpringMVC框架配置

​    进行完上面的配置，那就说明现在基本的开发环境已经搭建好了，现在要开始进行SpringMVC的网站开发。



​    打开src\main\webapp\WEB-INF\下的web.xml文件，稍微更新一下web.xml的版本，可以支持更高级的一些语法，如下：

```
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1">

    <display-name>SpringMVCDemo Web Application</display-name>

</web-app>
```

   在<web-app>中加入一个servlet：

```
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         version="3.1">

    <display-name>SpringMVCDemo Web Application</display-name>

    <servlet>
        <servlet-name>mvc-dispatcher</servlet-name>
        <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet-mapping>
        <servlet-name>mvc-dispatcher</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>
</web-app>
```

   该servlet名为mvc-dispatcher（名称可修改），用于拦截请求（url-pattern为 / ，说明拦截所有请求），并交由Spring MVC的后台控制器来处理。这一项配置是必须的。

   为了能够处理中文的post请求，再配置一个encodingFilter，以避免post请求中文出现乱码情况：

```
<filter>
    <filter-name>encodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
    <init-param>
        <param-name>encoding</param-name>
        <param-value>UTF-8</param-value>
    </init-param>
    <init-param>
        <param-name>forceEncoding</param-name>
        <param-value>true</param-value>
    </init-param>
</filter>
<filter-mapping>
    <filter-name>encodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```

  至此，web.xml配置完毕。



​    在配置完web.xml后，需在web.xml同级目录下新建 mvc-dispatcher-servlet.xml（-servlet前面是在servlet里面定义的servlet名）：

![img](http://static.oschina.net/uploads/space/2016/0308/115510_gst7_2287879.png)

![img](http://static.oschina.net/uploads/space/2016/0308/115738_2e4p_2287879.png)

​    新建该xml文件后，点击右上角的configure，出现 Setup Frameworks界面，点击OK，这样，IntelliJ IDEA就识别了SpringMVC的配置文件：

![img](http://static.oschina.net/uploads/space/2016/0308/115931_Yfbh_2287879.png)

​    mvc-dispatcher-servlet.xml文件如下：

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

</beans>
```

   MVC框架有model、view、controller三部分组成。model一般为一些基本的Java Bean，view用于进行相应的页面显示，controller用于处理网站的请求。

   在src\main\java中新建一个用于保存controller的package：

![img](http://static.oschina.net/uploads/space/2016/0308/120148_zxdz_2287879.png)

![img](http://static.oschina.net/uploads/space/2016/0308/120330_gCaJ_2287879.png)

​    在controller包中新建java类MainController（名称并不固定，可任意取），并修改如下：

![img](http://static.oschina.net/uploads/space/2016/0308/120627_WMr5_2287879.png)

![img](http://static.oschina.net/uploads/space/2016/0308/120731_6JEm_2287879.png)

```
package com.gdtop.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@Controller
public class MainController {

    @RequestMapping(value = "/", method = RequestMethod.GET)
    public String index() {
        return "index";
    }
}
```

![img](http://static.oschina.net/uploads/space/2016/0308/121141_lYpA_2287879.png)

​    （1）@Controller注解：采用注解的方式，可以明确地定义该类为处理请求的Controller类；

​    （2）@RequestMapping()注解：用于定义一个请求映射，value为请求的url，值为 / 说明，该请求首页请求，method用以指定该请求类型，一般为get和post；

​    （3）return "index"：处理完该请求后返回的页面，此请求返回 index.jsp页面。

​    回到mvc-dispatcher-servlet.xml，进行相关配置。首先加入component-scan标签，指明controller所在的包，并扫描其中的注解（最好不要复制，输入时按IDEA会在beans xmlns中添加相关内容）：

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <!--指明 controller 所在包，并扫描其中的注解-->
    <context:component-scan base-package="com.gdtop.controller"/>
</beans>
```

​    再进行js、image、css等静态资源访问的相关配置，这样，SpringMVC才能访问网站内的静态资源：

```
<!-- 静态资源(js、image等)的访问 -->
<mvc:default-servlet-handler/>
```

   再开启springmvc注解模式，由于我们利用注解方法来进行相关定义，可以省去很多的配置：

```
<!-- 开启注解 -->
<mvc:annotation-driven/>
```

再进行视图解析器的相关配置：

```
<!--ViewResolver 视图解析器-->
<!--用于支持Servlet、JSP视图解析-->
<bean id="jspViewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
    <property name="viewClass" value="org.springframework.web.servlet.view.JstlView"/>
    <property name="prefix" value="/WEB-INF/pages/"/>
    <property name="suffix" value=".jsp"/>
</bean>
```

​    关于controller如何找到视图文件，这里需要详细的说明。在 controller 的一个方法中，返回的字符串定义了所需访问的jsp的名字（如上面的index）。在jspViewResolver中，有两个属性，一个是prefix，定义了所需访问的文件路径前缀，另一是suffix，表示要访问的文件的后缀，这里为 .jsp。那么，如果返回字符串是 xxx ，SpringMVC就会找到 /WEB-INF/pages/xxx.jsp 文件。

   完成以上配置后，mvc-dispatcher-servlet.xml文件如下图所示：

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd">

    <!--指明 controller 所在包，并扫描其中的注解-->
    <context:component-scan base-package="com.gdtop.controller"/>

    <!-- 静态资源(js、image等)的访问 -->
    <mvc:default-servlet-handler/>

    <!-- 开启注解 -->
    <mvc:annotation-driven/>

    <!--ViewResolver 视图解析器-->
    <!--用于支持Servlet、JSP视图解析-->
    <bean id="jspViewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="viewClass" value="org.springframework.web.servlet.view.JstlView"/>
        <property name="prefix" value="/WEB-INF/pages/"/>
        <property name="suffix" value=".jsp"/>
    </bean>
</beans>
```

​    我们删除 webapp 目录下的 index.jsp 文件，在WEB-INF目录下新建文件夹pages，再在pages目录下新建 index.jsp，并修改为如下所示：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC Demo 首页</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<h1>这里是SpringMVC Demo首页</h1>

<h3>出现此页面，说明配置成功。</h3>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

![img](http://static.oschina.net/uploads/space/2016/0308/133040_2Omd_2287879.png)

这里使用了Bootstrap的CDN加速服务，如果要使用本地的Bootstrap，请前往[Bootstrap官网](http://v3.bootcss.com/)下载，并放在 webapp 目录下，然后引入到 index.jsp 中，这里不做详细介绍。

现在，需要配置 Tomcat 来运行该项目。点击界面右上角的向下箭头，选择 Edit Configurations：

![img](http://static.oschina.net/uploads/space/2016/0308/133325_Qvqz_2287879.png)

点击左上角的”+“号，选择Tomcat Server，（如果没有请选择最下方的33 items more，找到Tomcat Server），再选择Local：

![img](http://static.oschina.net/uploads/space/2016/0308/133538_cgwt_2287879.png)

进入如下界面：

![img](http://static.oschina.net/uploads/space/2016/0308/133720_fg9R_2287879.png)

点击 Application server 右边的 Configure，导入Tomcat 目录（项目已更新到Tomcat8，请按照自身版本导入）：

![img](http://static.oschina.net/uploads/space/2016/0308/134140_xjUq_2287879.png)

在配置好tomcat的路径后，如下图所示，发现依然存在警告，且左方的Tomcat7图标上有一个错误标记，说明还没有配置完全：

![img](http://static.oschina.net/uploads/space/2016/0308/134439_ThnH_2287879.png)

我们还需要将项目部署到 Tomcat 服务器中。点击 Deployment，再点击右边的”+“号，添加一个Artifact：

![img](http://static.oschina.net/uploads/space/2016/0308/223515_mXqO_2287879.png)

选择第二个：war exploded，点击OK，这样，该项目就已经部署到了tomcat中：

![img](http://static.oschina.net/uploads/space/2016/0308/134953_3WY0_2287879.png)

再点击OK，整个Tomcat配置结束：

![img](http://static.oschina.net/uploads/space/2016/0308/135145_q63A_2287879.png)

点击界面右上角的红框中的绿色箭头，就可以启动 Tomcat 了，其控制台输出将在 IDEA 下方显示

![img](http://static.oschina.net/uploads/space/2016/0308/135804_BZjx_2287879.png)

启动后，浏览器将自动弹出项目首页：

![img](http://static.oschina.net/uploads/space/2016/0308/135858_AxWx_2287879.png)

这样，说明配置完成。这里总结一下其相关机制：首先，浏览器访问 localhost:8080，后台controller拦截该请求，进行相应的处理（此处无），在跳转到视图 index.jsp进行显示。



### 六、数据库配置

​      下面，就要通过一个简单的例子，来介绍SpringMVC如何集成Spring Data JPA（由 Hibernate JPA 提供），来进行强大的数据库访问，并通过本章节的讲解，更加深刻地认识Controller是如何进行请求处理的，相信看完这一章节，你就可以开始你的开发工作了。

准备工作：

​    在src\main\java中新建两个包：com.gdtop.model、com.gdtop.repository，将在后面用上，如下图所示：

![img](http://static.oschina.net/uploads/space/2016/0308/140541_vzfm_2287879.png)



​      本文的讲解使用Mysql数据库，如果使用其它数据库的读者，可以去网上参考其他的配置教程，在此不做太多的叙述。数据库是一个底层的东西，底层的细节对上层的抽象并没有太大的影响，因此，只要配置好数据库，本章的内容仍然是适用于所有数据库的（貌似如此）。

​      假设我们现在要建立一个小小的博客系统，其数据库ER图如下所示（当然这只是一个小小的例子，真实的博客系统比这要复杂的多）：

![img](http://static.oschina.net/uploads/space/2016/0308/165825_C5z3_2287879.png)

​    新建一个数据库springdemo，在数据库中，有两张表：

​    （1）用户表user：用户登录信息，主键id设为自增；

​    （2）博文表blog：储存用户发表的博文，主键id设为自增，其中有一个外键user_id链接到user表。

​    详细表结构如下图所示：

![img](http://static.oschina.net/uploads/space/2016/0308/154242_uNGE_2287879.png)

![img](http://static.oschina.net/uploads/space/2016/0308/165707_Xx0o_2287879.png)

使用MySQL Workbench添加外键流程：

![img](http://static.oschina.net/uploads/space/2016/0308/154625_EKjj_2287879.png)

![img](http://static.oschina.net/uploads/space/2016/0308/170158_DzeJ_2287879.png)

注意：在添加外键时，应该根据需求设置，例如右边红框中的Foreign Key Options，默认在Delete时是NO ACTION，说明在删除一个用户时，如果数据库中存在该用户的文章，那么就无法删除该用户，也无法删除该用户的所有文章，而如果将该选项改为CASCADE，那么删除该用户，就会同时删除该用户所有的文章。通常后者是不太可取的，因为如果发生了删除用户的误操作，很有可能该用户的内容被连带删除，且不可逆，这也是实现真实系统时需要考虑的原因之一。



​    对于此前所接触的一些常用的框架中，一张数据表往往对应一个Java Bean。在SpringMVC中，这个Java Bean相当于model。那么，这个类是否需要自己来写呢？不需要，利用IntelliJ IDEA可以帮我们自动的生成这些JavaBean。

​    首先，右键项目，选择Add Framework Support：

![img](http://static.oschina.net/uploads/space/2016/0308/161733_veHn_2287879.png)

下拉选择JavaEE Persistence，右边provider选择Hibernate：

![img](http://static.oschina.net/uploads/space/2016/0308/191503_1Qcl_2287879.png)

注：这一部分有一点过时，更新的项目中直接把数据库的配置放在了mvc-dispatcher-servlet.xml中，但依然要做这一步的操作，为了这一步可以使用Persistence的工具。

关于新的配置，可以翻到博客底部。

​    在这一步结束后，我们可以发现，在resources里面生成了persistence.xml配置文件，左边栏出现了一个Persistence标题（若没有请点击左下角那个灰框）：

![img](http://static.oschina.net/uploads/space/2016/0308/191743_X28m_2287879.png)

​    persistemce.xml具体如下：

```
<?xml version="1.0" encoding="UTF-8"?>
<persistence xmlns="http://java.sun.com/xml/ns/persistence" version="2.0">

    <persistence-unit name="NewPersistenceUnit">
        <provider>org.hibernate.ejb.HibernatePersistence</provider>
        <properties>
            <property name="hibernate.connection.url" value=""/>
            <property name="hibernate.connection.driver_class" value=""/>
            <property name="hibernate.connection.username" value=""/>
            <property name="hibernate.connection.password" value=""/>
            <property name="hibernate.archive.autodetection" value="class"/>
            <property name="hibernate.show_sql" value="true"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="hbm2ddl.auto" value="update"/>
        </properties>
    </persistence-unit>
</persistence>
```

​    我们先不着急填写这个配置文件。点开左边栏的Persistence，显示如下图所示：

![img](http://static.oschina.net/uploads/space/2016/0308/191844_e9cw_2287879.png)

右键项目名，选择Generate Persistence Mapping，再选择By Database Schema：

![img](http://static.oschina.net/uploads/space/2016/0308/191911_tyeY_2287879.png)

出现如下界面，其主要需要配置的地方如下图红框所示：

![img](http://static.oschina.net/uploads/space/2016/0308/163428_RxJL_2287879.png)

​    点击Choose Data Source右边的三个点选择数据源，在弹出的界面左上角选择“+”，选择Mysql：

![img](http://static.oschina.net/uploads/space/2016/0308/163618_u1DC_2287879.png)

在如下界面填写主机、端口号、数据库名、用户名、密码，如果驱动丢失点击下面的Download可以下载驱动，点击 Test Connection可以测试数据库是否连接成功：

![img](http://static.oschina.net/uploads/space/2016/0308/163808_eb51_2287879.png)

​    在以上界面配置完成后，点OK，第一次使用需要Setup Master Password：

​    ![img](http://static.oschina.net/uploads/space/2016/0308/164622_rs6v_2287879.png)

​    回到如下页面，package填写model包（1），勾选Prefer primitive type使用原始数据类型（2），勾选Show default relationships以显示所有数据库关系（3），再点击刷新按钮（4），将会找到数据库中的两个表，勾选两个数据表（5），再勾选Generate Column Defination以生成每一列的描述信息（6）。选中blog表然后点击“+”号按钮，添加外键关系（7）。

![img](http://static.oschina.net/uploads/space/2016/0308/205813_NmEP_2287879.png)

![img](http://static.oschina.net/uploads/space/2016/0308/210658_pKKH_2287879.png)

​    点击OK后，在Database Schema Mapping中可以发现多出了两个关系，如图所示：

![img](http://static.oschina.net/uploads/space/2016/0308/210911_nFZM_2287879.png)

   再点击OK，稍后，打开model包，可以看到生成了两个Java Bean，在SpringMVC中称为两个实体，它们对应了数据库的两张表：

![img](http://static.oschina.net/uploads/space/2016/0308/170744_KzXw_2287879.png)

BlogEntity如下所示（注意把java.sql.Date改为java.util.Date）：

```
package com.gdtop.model;

import javax.persistence.*;
import java.util.Date;

@Entity
@Table(name = "blog", schema = "springdemo", catalog = "")
public class BlogEntity {
    private int id;
    private String title;
    private String content;
    private Date pubDate;
    private UserEntity userByUserId;

    @Id
    @Column(name = "id", nullable = false)
    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    @Basic
    @Column(name = "title", nullable = false, length = 100)
    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    @Basic
    @Column(name = "content", nullable = true, length = 255)
    public String getContent() {
        return content;
    }

    public void setContent(String content) {
        this.content = content;
    }

    @Basic
    @Column(name = "pub_date", nullable = false)
    public Date getPubDate() {
        return pubDate;
    }

    public void setPubDate(Date pubDate) {
        this.pubDate = pubDate;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;

        BlogEntity that = (BlogEntity) o;

        if (id != that.id) return false;
        if (title != null ? !title.equals(that.title) : that.title != null) return false;
        if (content != null ? !content.equals(that.content) : that.content != null) return false;
        if (pubDate != null ? !pubDate.equals(that.pubDate) : that.pubDate != null) return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = id;
        result = 31 * result + (title != null ? title.hashCode() : 0);
        result = 31 * result + (content != null ? content.hashCode() : 0);
        result = 31 * result + (pubDate != null ? pubDate.hashCode() : 0);
        return result;
    }

    @ManyToOne
    @JoinColumn(name = "user_id", referencedColumnName = "id", nullable = false)
    public UserEntity getUserByUserId() {
        return userByUserId;
    }

    public void setUserByUserId(UserEntity userByUserId) {
        this.userByUserId = userByUserId;
    }
}
```

​    再看UserEntity：

```
package com.gdtop.model;

import javax.persistence.*;
import java.util.Collection;

@Entity
@Table(name = "user", schema = "springdemo", catalog = "")
public class UserEntity {
    private int id;
    private String nickname;
    private String password;
    private String firstName;
    private String lastName;
    private Collection<BlogEntity> blogsById;

    @Id
    @Column(name = "id", nullable = false)
    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    @Basic
    @Column(name = "nickname", nullable = false, length = 45)
    public String getNickname() {
        return nickname;
    }

    public void setNickname(String nickname) {
        this.nickname = nickname;
    }

    @Basic
    @Column(name = "password", nullable = false, length = 45)
    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    @Basic
    @Column(name = "first_name", nullable = true, length = 45)
    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    @Basic
    @Column(name = "last_name", nullable = true, length = 45)
    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;

        UserEntity that = (UserEntity) o;

        if (id != that.id) return false;
        if (nickname != null ? !nickname.equals(that.nickname) : that.nickname != null) return false;
        if (password != null ? !password.equals(that.password) : that.password != null) return false;
        if (firstName != null ? !firstName.equals(that.firstName) : that.firstName != null) return false;
        if (lastName != null ? !lastName.equals(that.lastName) : that.lastName != null) return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = id;
        result = 31 * result + (nickname != null ? nickname.hashCode() : 0);
        result = 31 * result + (password != null ? password.hashCode() : 0);
        result = 31 * result + (firstName != null ? firstName.hashCode() : 0);
        result = 31 * result + (lastName != null ? lastName.hashCode() : 0);
        return result;
    }

    @OneToMany(mappedBy = "userByUserId")
    public Collection<BlogEntity> getBlogsById() {
        return blogsById;
    }

    public void setBlogsById(Collection<BlogEntity> blogsById) {
        this.blogsById = blogsById;
    }
}
```



​    既然数据库已经导入了，那么前期准备工作基本完成，还需要进行最终的配置。

​    首先，打开mvc-dispatcher-servlet.xml，添加下列配置（如果某些地方报错，请选中并按Alt + Insert补全配置）：

```
<!-- 表示JPA Repository所在的包 -->
<jpa:repositories base-package="com.gdtop.repository"/>

<!-- 链接到persistence.xml -->
<bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalEntityManagerFactoryBean">
    <property name="persistenceUnitName" value="defaultPersistenceUnit"/>
</bean>

<!-- 事务管理 -->
<bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
    <property name="entityManagerFactory" ref="entityManagerFactory"/>
</bean>

<!-- 开启事务管理注解 -->
<tx:annotation-driven transaction-manager="transactionManager"/>
```

​    讲解：

​    （1） jpa:repositories：这一部分涉及到数据库的接口，将在后面详解；

​    （2）entityManagerFactory：实体管理器工厂，读取persistence.xml配置；

​    （3）transactionManager：事务管理器，利用entityManager进行事务管理；

​    （4）tx:annotation-driven：打开事务管理器的注解驱动，可以使用注解的方法操纵数据库。

整体如下所示：

```
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:jpa="http://www.springframework.org/schema/data/jpa"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd
       http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd 
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

    <!--指明 controller 所在包，并扫描其中的注解-->
    <context:component-scan base-package="com.gdtop.controller"/>

    <!-- 静态资源(js、image等)的访问 -->
    <mvc:default-servlet-handler/>

    <!-- 开启注解 -->
    <mvc:annotation-driven/>

    <!--ViewResolver 视图解析器-->
    <!--用于支持Servlet、JSP视图解析-->
    <bean id="jspViewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="viewClass" value="org.springframework.web.servlet.view.JstlView"/>
        <property name="prefix" value="/WEB-INF/pages/"/>
        <property name="suffix" value=".jsp"/>
    </bean>

    <!-- 表示JPA Repository所在的包 -->
    <jpa:repositories base-package="com.gdtop.repository"/>

    <!-- 链接到persistence.xml -->
    <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalEntityManagerFactoryBean">
        <property name="persistenceUnitName" value="defaultPersistenceUnit"/>
    </bean>

    <!-- 事务管理 -->
    <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
        <property name="entityManagerFactory" ref="entityManagerFactory"/>
    </bean>

    <!-- 开启事务管理注解 -->
    <tx:annotation-driven transaction-manager="transactionManager"/>
</beans>
```

​    下面，填充persistence.xml，***将persistence-unit的name改为 defaultPersistenceUnit***。在下面的文件中，我添加了一些更为详细的配置：

```
<?xml version="1.0" encoding="UTF-8"?>
<persistence xmlns="http://java.sun.com/xml/ns/persistence" version="2.0">

    <persistence-unit name="defaultPersistenceUnit"  transaction-type="RESOURCE_LOCAL">
        <provider>org.hibernate.ejb.HibernatePersistence</provider>
        <properties>
            <!-- 使用MySQL方言 -->
            <property name="hibernate.dialect" value="org.hibernate.dialect.MySQL5Dialect"/>
            <!-- 数据库连接的URL地址 -->
            <property name="hibernate.connection.url"
                      value="jdbc:mysql://localhost:3306/springdemo"/>
            <!-- 数据库连接的驱动 -->
            <property name="hibernate.connection.driver_class" value="com.mysql.jdbc.Driver"/>
            <!-- 数据库连接的用户名 -->
            <property name="hibernate.connection.username" value="root"/>
            <!-- 数据库连接的密码 -->
            <property name="hibernate.connection.password" value="111111"/>
            <!-- 显示SQL语句 -->
            <property name="hibernate.show_sql" value="true"/>

            <property name="hibernate.connection.useUnicode" value="true"/>
            <property name="hibernate.connection.characterEncoding" value="UTF-8"/>

            <!-- 在显示SQL语句时格式化语句 -->
            <property name="hibernate.format_sql" value="true"/>
            <property name="hibernate.use_sql_comments" value="false"/>
            <!-- 自动输出schema创建DDL语句 -->
            <property name="hibernate.hbm2ddl.auto" value="update"/>

            <!-- 数据库连接超时后自动重连 -->
            <property name="hibernate.connection.autoReconnect" value="true"/>
            <property name="connection.autoReconnectForPools" value="true"/>
            <property name="connection.is-connection-validation-required" value="true"/>
        </properties>
    </persistence-unit>
</persistence>
```

​    现在，重新启动tomcat，如果没有报错，说明数据库已经配置完成了，接下来就要讲解数据库的相关开发工作。

​      阅读评论发现许多同学的persistence.xml出现了问题，因为出现问题的原因可能有很多，尝试另外一种配置方法，无需persistence.xml，直接在mvc-dispatcher-servlet.xml中配置数据库，如下所示：

```
    <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
        <property name="persistenceUnitName" value="defaultPersistenceUnit"/>
        <property name="packagesToScan" value="com.gdtop.model" />
        <property name="jpaVendorAdapter">
            <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"/>
        </property>
        <property name="jpaProperties">
            <props>
                <prop key="hibernate.connection.driver_class">com.mysql.jdbc.Driver</prop>
                <prop key="hibernate.connection.url">jdbc:mysql://localhost:3306/springdemo?useSSL=false</prop>
                <prop key="hibernate.connection.username">root</prop>
                <prop key="hibernate.connection.password">111111</prop>
                <prop key="hibernate.show_sql">false</prop>
                <prop key="hibernate.connection.useUnicode">true</prop>
                <prop key="hibernate.connection.characterEncoding">UTF-8</prop>
                <prop key="hibernate.format_sql">true</prop>
                <prop key="hibernate.use_sql_comments">true</prop>
                <prop key="hibernate.hbm2ddl.auto">update</prop>
                <prop key="hibernate.connection.autoReconnect">true</prop>
                <prop key="hibernate.dialect">org.hibernate.dialect.MySQL5Dialect</prop>
                <prop key="connection.autoReconnectForPools">true</prop>
                <prop key="connection.is-connection-validation-required">true</prop>

                <prop key="hibernate.c3p0.validate">true</prop>
                <prop key="hibernate.connection.provider_class">org.hibernate.service.jdbc.connections.internal.C3P0ConnectionProvider</prop>
                <prop key="hibernate.c3p0.min_size">5</prop>
                <prop key="hibernate.c3p0.max_size">600</prop>
                <prop key="hibernate.c3p0.timeout">1800</prop>
                <prop key="hibernate.c3p0.max_statements">50</prop>
                <prop key="hibernate.c3p0.preferredTestQuery">SELECT 1;</prop>
                <prop key="hibernate.c3p0.testConnectionOnCheckout">true</prop>
                <prop key="hibernate.c3p0.idle_test_period">3000</prop>
            </props>
        </property>
    </bean>
```

​          删除persistence.xml，直接修改entityManagerFactory bean为如上图所示。这个方法可以摆脱persistence.xml的困扰，但是有一个小小的问题，如果之前没有添加Java EE Persistence这个框架的，文中的Persistence工具栏将不会显示。一个解决办法就是，先修改mvc-dispatcher-servlet，然后再添加Java EE Persistence框架，等能够看到Persistence工具栏后，删除persistence.xml，余下的步骤可以继续操作。



### 七、用户管理

​    既然我们要做一个博客管理系统，当然要首先实现我们的用户管理。在上一文中，我们已经配置好了数据库。接下来，就要实现网站的一些业务逻辑。



​    在实现用户管理操作之前，需要讲解一下JPA的开发工作。

​    首先，在com.gdtop.repository包内新建一个UserRepository接口：

![img](http://static.oschina.net/uploads/space/2016/0308/180204_kbzG_2287879.png)

​    让该接口继承 JpaRepository：

```
package com.gdtop.repository;

import com.gdtop.model.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<UserEntity, Integer> {
}
```

​    在JpaRepository中，定义了几个简化的操作数据库的方法：

​    （1） findAll()：查找表中所有记录；

​    （2）findOne(Integer id)：按id来查找某一条记录；

​    （3）findByXXX(Object xxx)：在这里XXX是一个字段名，根据该字段的值开查找所有记录；

​    （4）save()和delete()：添加一条记录以及删除一条记录。

​    除此之外，我们还可以在该repository中自定义新的方法，这将在稍后实际开发中提及。



​    为了尽可能的在省去篇幅的情况下，在此省去管理员操作的开发。默认在访问 /admin时，进入后台管理。

（1）查看所有用户

​    将MainController补充为如下形式：

```
package com.gdtop.controller;

import com.gdtop.model.UserEntity;
import com.gdtop.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import java.util.List;

@Controller
public class MainController {

    // 自动装配数据库接口，不需要再写原始的Connection来操作数据库
    @Autowired
    UserRepository userRepository;

    @RequestMapping(value = "/", method = RequestMethod.GET)
    public String index() {
        return "index";
    }

    @RequestMapping(value = "/admin/users", method = RequestMethod.GET)
    public String getUsers(ModelMap modelMap) {
        // 查询user表中所有记录
        List<UserEntity> userList = userRepository.findAll();

        // 将所有记录传递给要返回的jsp页面，放在userList当中
        modelMap.addAttribute("userList", userList);

        // 返回pages目录下的admin/users.jsp页面
        return "admin/users";
    }
}
```

​    讲解：

1. 1. 自动装配：相当于数据库操作的极简化，只要定义了就可以直接进行数据库操作，不用再去管开启连接、关闭连接等问题
   2. 找到所有记录：使用JpaRepository的默认方法findAll()。
   3. modelMap：用于将controller方法里面的参数传递给所需的jsp页面，以进行相关显示。

​    现在，需要在pages下新建目录admin，并新建users.jsp页面，以进行用户的管理：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC 用户管理</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 博客系统-用户管理</h1>
    <hr/>

    <h3>所有用户 <a href="/admin/users/add" type="button" class="btn btn-primary btn-sm">添加</a></h3>

    <!-- 如果用户列表为空 -->
 <c:if test="${empty userList}">
        <div class="alert alert-warning" role="alert">
            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>User表为空，请<a href="/admin/users/add" type="button" class="btn btn-primary btn-sm">添加</a>
        </div>
    </c:if>

    <!-- 如果用户列表非空 -->
 <c:if test="${!empty userList}">
        <table class="table table-bordered table-striped">
            <tr>
                <th>ID</th>
                <th>昵称</th>
                <th>姓名</th>
                <th>密码</th>
                <th>操作</th>
            </tr>

            <c:forEach items="${userList}" var="user">
                <tr>
                    <td>${user.id}</td>
                    <td>${user.nickname}</td>
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.password}</td>
                    <td>
                        <a href="/admin/users/show/${user.id}" type="button" class="btn btn-sm btn-success">详情</a>
                        <a href="/admin/users/update/${user.id}" type="button" class="btn btn-sm btn-warning">修改</a>
                        <a href="/admin/users/delete/${user.id}" type="button" class="btn btn-sm btn-danger">删除</a>
                    </td>
                </tr>
            </c:forEach>
        </table>
    </c:if>
</div>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​    讲解：

1. <c>标签：在jsp中使用了jstl语法，可以方便地进行一些判断<c:if>与遍历操作<c:forEach>；
2. 页面使用了Bootstrap，部分功能将在之后实现。

​    运行Tomcat，在浏览器中输入 http://localhost:8080/admin/users，进入用户管理界面，显示如下：

![img](http://static.oschina.net/uploads/space/2016/0308/214510_mwTz_2287879.png)

​    由于目前数据库中没有数据，因而显示为空，现在需要向数据库中添加用户。

（2）添加用户

​    在MainController中增加两个方法：

```
// get请求，访问添加用户 页面
@RequestMapping(value = "/admin/users/add", method = RequestMethod.GET)
public String addUser() {
    // 转到 admin/addUser.jsp页面
    return "admin/addUser";
}

// post请求，处理添加用户请求，并重定向到用户管理页面
@RequestMapping(value = "/admin/users/addP", method = RequestMethod.POST)
public String addUserPost(@ModelAttribute("user") UserEntity userEntity) {
    // 注意此处，post请求传递过来的是一个UserEntity对象，里面包含了该用户的信息
    // 通过@ModelAttribute()注解可以获取传递过来的'user'，并创建这个对象

    // 数据库中添加一个用户，该步暂时不会刷新缓存
    //userRepository.save(userEntity);

    // 数据库中添加一个用户，并立即刷新缓存
    userRepository.saveAndFlush(userEntity);

    // 重定向到用户管理页面，方法为 redirect:url
    return "redirect:/admin/users";
}
```

​    讲解：

1. /admin/users/add请求：get请求转到添加用户页面
2. /admin/users/addP请求：post请求收集数据并存库
3. @ModelAttribute注解：收集post过来的数据（在此，相当于post过来了一整个userEntity，不用一个一个地取）
4. save()和saveAndFlush()：save()方法处理完毕后，数据依然在缓冲区未写入数据库，使用saveAndFlush()可以立即刷新缓冲区，写入数据库
5. redirect:/admin/users：这里使用重定向，可以让该方法重定向访问一个请求，ruturn之后，将跳转到 :/admin/users 所访问的页面。

现在，在pages的admin目录下新建一个addUser.jsp：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC 添加用户</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 添加用户</h1>
    <hr/>
    <form:form action="/admin/users/addP" method="post" commandName="user" role="form">
        <div class="form-group">
            <label for="firstName">Nickname:</label>
            <input type="text" class="form-control" id="nickname" name="nickname" placeholder="Enter Nickname:"/>
        </div>
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" class="form-control" id="firstName" name="firstName" placeholder="Enter FirstName:"/>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" class="form-control" id="lastName" name="lastName" placeholder="Enter LastName:"/>
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="text" class="form-control" id="password" name="password" placeholder="Enter Password:"/>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-sm btn-success">提交</button>
        </div>
    </form:form>
</div>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​    讲解：

1. <form:form>标签：使用Spring的form标签，可以方便的收集整块数据，commondName=“user”说明form内的内容都保存在这个user实例中，然后将整个user实例传递给controller处理。在所有的input标签中，name一定要与UserEntity中的成员相同，不然无法找到。
2. 在提交之后，后台将会处理 /admin/users/addP 请求。

​    现在，重新启动服务器，访问 http://localhost:8080/admin/users/add 页面，如下图所示：

添加页 http://localhost:8080/admin/users/add

![1561292582330](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561292582330.png)

​    输入数据，点击提交，数据库中将会写入新的用户，重新跳转到用户管理页面：

http://localhost:8080/admin/users

![1561291689171](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561291689171.png)

（3）查看用户详情

​    在MainController中加入查看详情操作：

```
// 查看用户详情
// @PathVariable可以收集url中的变量，需匹配的变量用{}括起来
// 例如：访问 localhost:8080/admin/users/show/1 ，将匹配 id = 1
@RequestMapping(value = "/admin/users/show/{id}", method = RequestMethod.GET)
public String showUser(@PathVariable("id") Integer userId, ModelMap modelMap) {

    // 找到userId所表示的用户
    UserEntity userEntity = userRepository.findOne(userId);

    // 传递给请求页面
    modelMap.addAttribute("user", userEntity);
    return "admin/userDetail";
}
```

​    在pages目录下新建 userDetail.jsp：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC 用户详情</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 用户详情</h1>
    <hr/>

    <table class="table table-bordered table-striped">
        <tr>
            <th>ID</th>
            <td>${user.id}</td>
        </tr>
        <tr>
            <th>Nickname</th>
            <td>${user.nickname}</td>
        </tr>
        <tr>
            <th>First Name</th>
            <td>${user.firstName}</td>
        </tr>
        <tr>
            <th>Last Name</th>
            <td>${user.lastName}</td>
        </tr>
        <tr>
            <th>Password</th>
            <td>${user.password}</td>
        </tr>
    </table>
</div>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​    讲解：如何访问一个实例内的数据？

​        使用${}语法，在{}内可以使用类似Java的方法方便地访问数据。

​    重启服务器，进入 http://localhost:8080/admin/users ，点击ID = 1的用户的 详情 按钮，可以查看用户详情：

详情页 http://localhost:8080/admin/users/show/1

![1561292392666](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561292392666.png)

​    从url可以看出，访问的是ID=1的用户的详细情况，这样的URL采用了REST风格设计，看起来更加简便。

（4）修改用户信息

​    现在我们要对用户信息做一定的修改，那该如何做呢。假设我们要能够修改全部的数据（除了id），JpaRepository未定义update方法，需要我们自己定义。

​    打开UserRepository，添加updateUser()接口方法：

```
package com.gdtop.repository;

import com.gdtop.model.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

@Repository
public interface UserRepository extends JpaRepository<UserEntity, Integer> {

    @Modifying      // 说明该方法是修改操作
    @Transactional  // 说明该方法是事务性操作
    // 定义查询
    // @Param注解用于提取参数
    @Query("update UserEntity us set us.nickname=:qNickname, us.firstName=:qFirstName, us.lastName=:qLastName, us.password=:qPassword where us.id=:qId")
    public void updateUser(@Param("qNickname") String nickname, @Param("qFirstName") String firstName,
                           @Param("qLastName") String qLastName, @Param("qPassword") String password, @Param("qId") Integer id);
}
```

​    在MainController中定义update操作方法：

```
// 更新用户信息 页面
@RequestMapping(value = "/admin/users/update/{id}", method = RequestMethod.GET)
public String updateUser(@PathVariable("id") Integer userId, ModelMap modelMap) {

    // 找到userId所表示的用户
    UserEntity userEntity = userRepository.findOne(userId);

    // 传递给请求页面
    modelMap.addAttribute("user", userEntity);
    return "admin/updateUser";
}

// 更新用户信息 操作
@RequestMapping(value = "/admin/users/updateP", method = RequestMethod.POST)
public String updateUserPost(@ModelAttribute("userP") UserEntity user) {

    // 更新用户信息
    userRepository.updateUser(user.getNickname(), user.getFirstName(),
            user.getLastName(), user.getPassword(), user.getId());
    userRepository.flush(); // 刷新缓冲区
    return "redirect:/admin/users";
}
```

​    然后，在pages目录下，新建updateUser.jsp文件：

```
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC Demo 更新用户</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 更新用户信息</h1>
    <hr/>

    <form:form action="/admin/users/updateP" method="post" commandName="userP" role="form">
        <div class="form-group">
            <label for="firstName">Nickname:</label>
            <input type="text" class="form-control" id="nickname" name="nickname" placeholder="Enter Nickname:"
 value="${user.nickname}"/>
        </div>
        <div class="form-group">
            <label for="firstName">First Name:</label>
            <input type="text" class="form-control" id="firstName" name="firstName" placeholder="Enter FirstName:"
 value="${user.firstName}"/>
        </div>
        <div class="form-group">
            <label for="lastName">Last Name:</label>
            <input type="text" class="form-control" id="lastName" name="lastName" placeholder="Enter LastName:"
 value="${user.lastName}"/>
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="text" class="form-control" id="password" name="password" placeholder="Enter Password:"
 value="${user.password}"/>
        </div>
        <!-- 把 id 一并写入 userP 中 -->
 <input type="hidden" id="id" name="id" value="${user.id}"/>

        <div class="form-group">
            <button type="submit" class="btn btn-sm btn-success">提交</button>
        </div>
    </form:form>
</div>


<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​    重启服务器，进入 http://localhost:8080/admin/users ，点击第一个用户的 修改 按钮，做如下修改：

 http://localhost:8080/admin/users/update/1

![1561292494564](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561292494564.png)

​    提交后，重新跳转回用户管理页面，可发现修改完成：

![1561291689171](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561291689171.png)

（5）删除用户

​    现在，新添加一个用户：

添加页 http://localhost:8080/admin/users/add

![1561292582330](C:\Users\adward\AppData\Roaming\Typora\typora-user-images\1561292582330.png)

​    现在我们需要删掉新加入的用户，打开MainController，加入以下方法：

```
// 删除用户
@RequestMapping(value = "/admin/users/delete/{id}", method = RequestMethod.GET)
public String deleteUser(@PathVariable("id") Integer userId) {

    // 删除id为userId的用户
    userRepository.delete(userId);
    // 立即刷新
    userRepository.flush();
    return "redirect:/admin/users";
}
```

​    重启服务器，进入 http://localhost:8080/admin/users ，点击ID=2的用户的删除按钮，在controller中处理完之后，将跳转回用户管理界面：

![img](http://static.oschina.net/uploads/space/2016/0308/221353_qHtM_2287879.png)

 

​    这样，增删该查基本完成了。

​    其实，更到这里，基本就可以开始开发工作了，还有一些其他的功能，都需要通过平时的积累以及多查资料来完成。例如JSON数据的处理，异步请求的处理，以及相关外键等操作。

​    要知道的是，读者所阅读的三十分钟，需要写这篇文章的人数个小时的努力，整理确实不易。读文章要有举一反三地态度，才能真正的把东西学精学全。



### 八、博客文章管理

​        博客的管理与用户的管理有许多的相似之处，但是另外多了外键的操作，下面做简单的说明。



​        查看文章的操作相对简单。首先在com.gdtop.repository中添加BlogRepository，方法与UserRepository类似：

```
package com.gdtop.repository;

import com.gdtop.model.BlogEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface BlogRepository extends JpaRepository<BlogEntity, Integer> {
}
```

​        在com.gdtop.controller中添加一个BlogController类，并添加以下方法（当然也可以写在MainController中，在较大型的项目开发中，最好对各类的操作进行一个区分，以增强代码的可读性）：

```
package com.gdtop.controller;

import com.gdtop.model.BlogEntity;
import com.gdtop.repository.BlogRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import java.util.List;

@Controller
public class BlogController {

    @Autowired
    BlogRepository blogRepository;
    
    // 查看所有博文
    @RequestMapping(value = "/admin/blogs", method = RequestMethod.GET)
    public String showBlogs(ModelMap modelMap) {
        List<BlogEntity> blogList = blogRepository.findAll();
        modelMap.addAttribute("blogList", blogList);
        return "admin/blogs";
    }
}
```

​        接下来，在pages/admin目录下新建blogs.jsp文件：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC 博客管理</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 博客系统-博客管理</h1>
    <hr/>

    <h3>所有博客 <a href="/admin/blogs/add" type="button" class="btn btn-primary btn-sm">添加</a></h3>

    <!-- 如果用户列表为空 -->
 <c:if test="${empty blogList}">
        <div class="alert alert-warning" role="alert">
            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>Blog表为空，请<a href="/admin/blogs/add" type="button" class="btn btn-primary btn-sm">添加</a>
        </div>
    </c:if>

    <!-- 如果用户列表非空 -->
 <c:if test="${!empty blogList}">
        <table class="table table-bordered table-striped">
            <tr>
                <th>ID</th>
                <th>标题</th>
                <th>作者</th>
                <th>发布日期</th>
                <th>操作</th>
            </tr>

            <c:forEach items="${blogList}" var="blog">
                <tr>
                    <td>${blog.id}</td>
                    <td>${blog.title}</td>
                    <td>${blog.userByUserId.nickname}, ${blog.userByUserId.firstName} ${blog.userByUserId.lastName}</td>
                    <td><fmt:formatDate value="${blog.pubDate }" pattern="yyyy-MM-dd"/></td>
                    <td>
                        <a href="/admin/blogs/show/${blog.id}" type="button" class="btn btn-sm btn-success">详情</a>
                        <a href="/admin/blogs/update/${blog.id}" type="button" class="btn btn-sm btn-warning">修改</a>
                        <a href="/admin/blogs/delete/${blog.id}" type="button" class="btn btn-sm btn-danger">删除</a>
                    </td>
                </tr>
            </c:forEach>
        </table>
    </c:if>
</div>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​        先不要急着运行代码，我们来看看blogs.jsp与users.jsp有何不同。

​        注意到，在查看博文作者的时候，使用了如下代码：

```
<td>${blog.userByUserId.nickname}, ${blog.userByUserId.firstName} ${blog.userByUserId.lastName}</td>
```

​        也就是说，通过blog的userByUserId对象，找到了博文的作者，并且输出了他的昵称以及姓名。在这里，外键起到了决定性的作用。下面我们运行Tomcat，浏览器中输入http://localhost:8080/admin/blogs，可以看到如下界面：

![img](http://static.oschina.net/uploads/space/2016/0318/204107_Gees_2287879.png)



 当然，现在数据库中是没有数据的，不用着急，我们先实现博文的添加功能。回到BlogController，添加addBlog的GET和POST操作：

```
package com.gdtop.controller;

import com.gdtop.model.BlogEntity;
import com.gdtop.model.UserEntity;
import com.gdtop.repository.BlogRepository;
import com.gdtop.repository.UserRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import java.util.List;

@Controller
public class BlogController {

    @Autowired
    BlogRepository blogRepository;

    @Autowired
    UserRepository userRepository;

    // 查看所有博文
    @RequestMapping(value = "/admin/blogs", method = RequestMethod.GET)
    public String showBlogs(ModelMap modelMap) {
        List<BlogEntity> blogList = blogRepository.findAll();
        modelMap.addAttribute("blogList", blogList);
        return "admin/blogs";
    }


    // 添加博文
    @RequestMapping(value = "/admin/blogs/add", method = RequestMethod.GET)
    public String addBlog(ModelMap modelMap) {
        List<UserEntity> userList = userRepository.findAll();
        // 向jsp注入用户列表
        modelMap.addAttribute("userList", userList);
        return "admin/addBlog";
    }

    // 添加博文，POST请求，重定向为查看博客页面
    @RequestMapping(value = "/admin/blogs/addP", method = RequestMethod.POST)
    public String addBlogPost(@ModelAttribute("blog") BlogEntity blogEntity) {
        // 打印博客标题
        System.out.println(blogEntity.getTitle());
        // 打印博客作者
        System.out.println(blogEntity.getUserByUserId().getNickname());
        // 存库
        blogRepository.saveAndFlush(blogEntity);
        // 重定向地址
        return "redirect:/admin/blogs";
    }
}
```

​       接下来，在pages/admin目录下新建addBlog.jsp文件：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC 添加博客</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 添加博客</h1>
    <hr/>
    <form:form action="/admin/blogs/addP" method="post" commandName="blog" role="form">
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" class="form-control" id="title" name="title" placeholder="Enter Title:"/>
        </div>
        <div class="form-group">
            <label for="userByUserId.id">Author:</label>
            <select class="form-control" id="userByUserId.id" name="userByUserId.id">
                <c:forEach items="${userList}" var="user">
                    <option value="${user.id}">${user.nickname}, ${user.firstName} ${user.lastName}</option>
                </c:forEach>
            </select>
        </div>
        <div class="form-group">
            <label for="content">Content:</label>
            <textarea class="form-control" id="content" name="content" rows="3" placeholder="Please Input Content"></textarea>
        </div>
        <div class="form-group">
            <label for="pubDate">Publish Date:</label>
            <input type="date" class="form-control" id="pubDate" name="pubDate"/>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-sm btn-success">提交</button>
        </div>
    </form:form>
</div>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​      讲解：

​        （1）首先在作者一栏使用了选择框，通过select来选择该博文的作者，注意到select标签的id和name都是userByUserId.id（id可以不同，但name必须如此），也就是说，需要通过blog的外键来定位到所需要选择的作者。而在其选项组中，使用user.id来进行赋值，这样，就能把blog和user表相关联，是不是很方便呢？

​        （2）Content处使用了textarea标签，关于文中的一些标签的用法可以[参照Bootstrap中文官网](http://v3.bootcss.com/)（没有Bootstrap实在不会写前端。。），注意由于数据表的限制，请将字数保存在255以下。当然也可以把数据表中的字段改为TEXT，以支持更长的输入。

​        （3）发布日期的选取，采用了最简单的H5 date控件，有兴趣做成选择框的话，可以引入[Bootstrap Datetimepicker](http://www.bootcss.com/p/bootstrap-datetimepicker/)，这是一个比较好的组件，但不是本文的重点，在此使用最简单的。点击其右方的下三角，可以选择日期，也可以直接输入：

 

​        说了真么多，我们来重启一下Tomcat，点击博客管理界面的添加按钮，添加以下内容：

![img](http://static.oschina.net/uploads/space/2016/0318/213610_wmNi_2287879.png)

​      注意Author是一个select选框，如下图所示，（如果选项很少效果不太好的话，请自行到用户管理界面多添加几个用户再来）：

![img](http://static.oschina.net/uploads/space/2016/0318/213753_AlTA_2287879.png)

​       点击提交，系统重新跳转到了博客管理界面，这里已经显示出了所添加的博客列表：

![img](http://static.oschina.net/uploads/space/2016/0318/213859_axuZ_2287879.png)



​       有了前面的基础，这个就很好实现了，不多说，趁热打铁，在BlogController中添加如下方法：

```
// 查看博文详情，默认使用GET方法时，method可以缺省
@RequestMapping("/admin/blogs/show/{id}")
public String showBlog(@PathVariable("id") int id, ModelMap modelMap) {
    BlogEntity blog = blogRepository.findOne(id);
    modelMap.addAttribute("blog", blog);
    return "admin/blogDetail";
}
```

​       在pages/admin目录下新建文件blogDetail.jsp：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC 博文详情</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 博文详情</h1>
    <hr/>

    <table class="table table-bordered table-striped">
        <tr>
            <th>ID</th>
            <td>${blog.id}</td>
        </tr>
        <tr>
            <th>Title</th>
            <td>${blog.title}</td>
        </tr>
        <tr>
            <th>Author</th>
            <td>${blog.userByUserId.nickname}, ${blog.userByUserId.firstName} ${blog.userByUserId.lastName}</td>
        </tr>
        <tr>
            <th>Content</th>
            <td>${blog.content}</td>
        </tr>
        <tr>
            <th>Publish Date</th>
            <td><fmt:formatDate value="${blog.pubDate}" pattern="yyyy年MM月dd日"/></td>
        </tr>
    </table>
</div>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​        注意：在输出日期的时候使用了fmt标签，请在顶部引入fmt标签。

​        现在重启服务器，进入博客管理页面，点击刚才添加的博文的详情按钮，查看该博文的详情：

![img](http://static.oschina.net/uploads/space/2016/0318/221110_PE1v_2287879.png)



​      写完了增加和查看的操作，现在实现修改的操作，内容依旧与用户操作类似。首先，在BlogRepository中添加如下代码：

```
// 修改博文操作
@Modifying
@Transactional
@Query("update BlogEntity blog set blog.title=:qTitle, blog.userByUserId.id=:qUserId," +
        " blog.content=:qContent, blog.pubDate=:qPubDate where blog.id=:qId")
void updateBlog(@Param("qTitle") String title, @Param("qUserId") int userId, @Param("qContent") String content,
                @Param("qPubDate") Date pubDate, @Param("qId") int id);
```

​          接下来，在BlogController中添加修改博文的GET和POST方法：

```
// 修改博文内容，页面
@RequestMapping("/admin/blogs/update/{id}")
public String updateBlog(@PathVariable("id") int id, ModelMap modelMap) {
    // 是不是和上面那个方法很像
    BlogEntity blog = blogRepository.findOne(id);
    List<UserEntity> userList = userRepository.findAll();
    modelMap.addAttribute("blog", blog);
    modelMap.addAttribute("userList", userList);
    return "admin/updateBlog";
}

// 修改博客内容，POST请求
@RequestMapping(value = "/admin/blogs/updateP", method = RequestMethod.POST)
public String updateBlogP(@ModelAttribute("blogP") BlogEntity blogEntity) {
    // 更新博客信息
    blogRepository.updateBlog(blogEntity.getTitle(), blogEntity.getUserByUserId().getId(),
            blogEntity.getContent(), blogEntity.getPubDate(), blogEntity.getId());
    blogRepository.flush();
    return "redirect:/admin/blogs";
}
```

​        新建updateBlog.jsp页面：

```
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
 <title>SpringMVC 修改博客</title>

    <!-- 新 Bootstrap 核心 CSS 文件 -->
 <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>SpringMVC 修改博客</h1>
    <hr/>
    <form:form action="/admin/blogs/updateP" method="post" commandName="blogP" role="form">
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" class="form-control" id="title" name="title" placeholder="Enter Title:" value="${blog.title}"/>
        </div>
        <div class="form-group">
            <label for="userByUserId.id">Author:</label>
            <select class="form-control" id="userByUserId.id" name="userByUserId.id">
                <c:forEach items="${userList}" var="user">
                    <c:if test="${user.id==blog.userByUserId.id}">
                        <option value="${user.id}" selected="selected">${user.nickname}, ${user.firstName} ${user.lastName}</option>
                    </c:if>
                    <c:if test="${user.id!=blog.userByUserId.id}">
                        <option value="${user.id}">${user.nickname}, ${user.firstName} ${user.lastName}</option>
                    </c:if>
                </c:forEach>
            </select>
        </div>
        <div class="form-group">
            <label for="content">Content:</label>
            <textarea class="form-control" id="content" name="content" rows="3"
 placeholder="Please Input Content">${blog.content}</textarea>
        </div>
        <div class="form-group">
            <label for="pubDate">Publish Date:</label>
            <input type="date" class="form-control" id="pubDate" name="pubDate"
 value="<fmt:formatDate value="${blog.pubDate }" pattern="yyyy-MM-dd"/>"/>
        </div>
        <!-- 把 id 一并写入 blogP 中 -->
 <input type="hidden" id="id" name="id" value="${blog.id}"/>
        <div class="form-group">
            <button type="submit" class="btn btn-sm btn-success">提交</button>
        </div>
    </form:form>
</div>

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</body>
</html>
```

​       注：感谢某位同学的指出，这里pubDate的输出如图下图所示：  

​       重启服务器，进入修改博客页面，做出一定的修改：

![img](http://static.oschina.net/uploads/space/2016/0328/143127_1aYI_2287879.png)

​        点击提交， 返回博客列表页面，可以查看修改。

![img](http://static.oschina.net/uploads/space/2016/0318/233547_nNbV_2287879.png)



​       删除博客的实现非常简单，在BlogController下加入以下方法：

```
// 删除博客文章
@RequestMapping("/admin/blogs/delete/{id}")
public String deleteBlog(@PathVariable("id") int id) {
    blogRepository.delete(id);
    blogRepository.flush();
    return "redirect:/admin/blogs";
}
```

​      重启服务器，随便添加一篇新的文章，然后删除之：

![img](http://static.oschina.net/uploads/space/2016/0318/234147_zrBQ_2287879.png)

​       点击删除按钮，删除第二篇文章，将返回博客管理界面：

![img](http://static.oschina.net/uploads/space/2016/0318/234300_n8o5_2287879.png)



​        这样，整个博客的增删改查操作就完成了，而这一系列的文章也即将接近尾声。还有许多的细节是可以优化的，SpringMVC还有许多优化代码的小技巧，能让你在开发时加省力，这一点是要在我们的学习和使用中去探索和思考的，特别作为一个WEB开发人员，探索和思考的能力是宝贵的。

​        在项目的目录下，IntelliJ IDEA生成了一个target文件夹，如下图所示：

![img](http://static.oschina.net/uploads/space/2016/0318/234911_x94H_2287879.png)

​        而springmvcdemo就是生成好的项目，我们把这个项目放到Tomcat的webapps目录下，然后启动Tomcat，访问 http://localhost:8080/springmvcdemo 就可以看到网站。

​        如果本文满足不了你的需求，你还需要许多更高级的操作，那么就应该查查文档了，访问 http://projects.spring.io/spring-framework/ 可以查看springmvc的详细文档，按照所使用的版本进行查阅。在 http://spring.io/projects 中还有许多其他的Spring框架，比如比较流行的Spring BOOT框架，以及本文中用到的Spring Data框架等。

​         关于Bootstrap，在前端开发上面，离了Bootstrap我还真难写出了像样的前端来，当然为了成为一个出色的 Full Stack Developer，会一点HTML+CSS+JS那肯定是有必要的。我维护过PHP的项目，开发过Django的项目，SpringMVC的项目也做了不少，甚至乎用Node.js搭建博客等都有一定的涉猎，这些项目无论哪一个都离不开前端知识的支持。如果对前端不太了解，又想速成的话，建议上[Bootstrap中文官网](http://v3.bootcss.com/)看看教程。